# =============================================================================
# Practice Deployment Configuration
# =============================================================================
# This is a simple staging deployment for learning DevOps!
# 
# What this deploys:
# - A frontend app (mycure)
# - A backend API (hapihub)
# - MongoDB database
# - MinIO object storage
# - Mailpit for email testing
# =============================================================================

global:
  # IMPORTANT: Change this to YOUR domain!
  # Options:
  #   - Your real domain: "practice.yourdomain.com"
  #   - Using nip.io: "YOUR_LB_IP.nip.io" (get IP after Gateway deploys)
  domain: stg.mediqueue.online
  
  # Namespace for this deployment
  namespace: mediqueue-staging
  
  # Environment identifier
  environment: staging
  
  # Node pool - leave empty for DOKS (no node selector needed)
  nodePool: ""
  
  # Gateway configuration (shared gateway in gateway-system namespace)
  gateway:
    name: shared-gateway
    namespace: gateway-system
  
  # Storage configuration
  # For DOKS, leave empty to use DigitalOcean's default storage class
  storage:
    provider: ""
    className: ""

# =============================================================================
# FRONTEND: MyCure Application
# =============================================================================
mycure:
  enabled: true
  
  image:
    repository: ghcr.io/mycurelabs/mycureapp
    tag: "10.2.6"
    pullPolicy: IfNotPresent
  
  replicaCount: 1
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi
  
  gateway:
    # Full hostname for the frontend
    hostname: "stg.mediqueue.online"
    sectionName: http  # Use HTTP listener (HTTPS needs TLS cert setup)
  
  config:
    API_URL: "https://api-stg.mediqueue.online"
    HAPIHUB_URL: "https://api-stg.mediqueue.online"
  
  podDisruptionBudget:
    enabled: false

# =============================================================================
# BACKEND: HapiHub API
# =============================================================================
hapihub:
  enabled: true
  
  image:
    repository: ghcr.io/mycurelabs/hapihub
    tag: "10.1.0"
    pullPolicy: IfNotPresent
  
  replicaCount: 1
  
  resources:
    requests:
      cpu: 250m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 1Gi
  
  gateway:
    # Full hostname for the API (first-level subdomain for free Cloudflare SSL)
    hostname: "api-stg.mediqueue.online"
    sectionName: http  # Use HTTP listener
    timeouts:
      request: "60s"
  
  livenessProbe:
    enabled: true
  
  readinessProbe:
    enabled: true
  
  podDisruptionBudget:
    enabled: false
  
  autoscaling:
    enabled: false
  
  # External Secrets disabled for practice
  # Enable this in production to sync secrets from cloud KMS
  externalSecrets:
    enabled: false
  
  # Environment variables for HapiHub
  env:
    - name: PUBLIC_URL
      value: "https://api-stg.mediqueue.online"
    - name: APP_URL
      value: "https://api-stg.mediqueue.online"
  
  mongodb:
    serviceName: mongodb
    database: hapihub
    username: root
    replicaSet: rs0

# =============================================================================
# DATABASE: MongoDB
# =============================================================================
mongodb:
  enabled: true
  
  fullnameOverride: "mongodb"

  # Use replicaset for proper database deployment
  architecture: replicaset
  replicaCount: 1

  image:
    repository: bitnamilegacy/mongodb
    tag: 7.0.15-debian-12-r0
  
  auth:
    rootUser: root
    # For practice, we'll create a simple secret
    # In production, use External Secrets
    existingSecret: mongodb

  # Provide default mongodb.conf since emptyDir overlay removes it
  configuration: |
    # mongod.conf
    storage:
      dbPath: /bitnami/mongodb/data/db
      journal:
        enabled: true
      directoryPerDB: false
    systemLog:
      destination: file
      quiet: false
      logAppend: true
      logRotate: reopen
      path: /opt/bitnami/mongodb/logs/mongodb.log
      verbosity: 0
    net:
      port: 27017
      unixDomainSocket:
        enabled: true
        pathPrefix: /opt/bitnami/mongodb/tmp
      ipv6: false
      bindIpAll: false
      bindIp: 127.0.0.1
    processManagement:
      fork: false
      pidFilePath: /opt/bitnami/mongodb/tmp/mongodb.pid
    setParameter:
      enableLocalhostAuthBypass: true
    security:
      authorization: disabled
  
  arbiter:
    enabled: false
  
  persistence:
    enabled: true
    storageClass: "gp2"  # Use EKS default storage class
    size: 10Gi
  
  # Enable volumePermissions to fix EBS volume permissions
  volumePermissions:
    enabled: true
  
  # Security context for EKS compatibility
  podSecurityContext:
    enabled: true
    fsGroup: 1001
  
  containerSecurityContext:
    enabled: true
    runAsUser: 1001
    runAsNonRoot: true
    readOnlyRootFilesystem: false
  
  resources:
    requests:
      cpu: 100m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi

  podDisruptionBudget:
    enabled: false

# =============================================================================
# STORAGE: MinIO Object Storage
# =============================================================================
minio:
  enabled: true
  
  fullnameOverride: "minio"
  
  image:
    repository: bitnamilegacy/minio
    tag: "2025.7.23-debian-12-r3"
  
  mode: standalone
  
  statefulset:
    replicaCount: 1
  
  auth:
    existingSecret: minio
  
  persistence:
    enabled: true
    storageClass: ""
    size: 5Gi  # Smaller for practice
  
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      cpu: 500m
      memory: 512Mi
  
  defaultBuckets: "practice-files"
  region: "us-east-1"
  
  gateway:
    enabled: true
    hostname: "storage-stg.mediqueue.online"

# =============================================================================
# EMAIL TESTING: Mailpit
# =============================================================================
mailpit:
  enabled: true
  
  resources:
    requests:
      cpu: 25m
      memory: 32Mi
    limits:
      cpu: 100m
      memory: 64Mi
  
  gateway:
    enabled: true
    hostname: "mail-stg.mediqueue.online"

# =============================================================================
# DISABLED FOR PRACTICE
# Enable these as you learn more
# =============================================================================
api:
  enabled: false

account:
  enabled: false

mycurev8:
  enabled: false

dentalemon:
  enabled: true
  
  image:
    repository: ghcr.io/jericho1050/dentalemonapp
    tag: "1.0.0"
    pullPolicy: IfNotPresent
  
  replicaCount: 1
  
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      cpu: 200m
      memory: 128Mi
  
  gateway:
    hostname: "dental-stg.mediqueue.online"  # First-level subdomain for free Cloudflare SSL
    sectionName: http
  
  config:
    API_URL: "https://api-stg.mediqueue.online"
    HAPIHUB_URL: "https://api-stg.mediqueue.online"
  
  podDisruptionBudget:
    enabled: false

syncd:
  enabled: false

postgresql:
  enabled: false

valkey:
  enabled: false

backup:
  enabled: false

# =============================================================================
# SECURITY
# =============================================================================
podSecurityStandards:
  enabled: true
  # Use baseline for MongoDB replica set compatibility
  # (restricted blocks some keyfile operations needed for replica sets)
  level: baseline

resourceQuotas:
  enabled: false

